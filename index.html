<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Live Voting Results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        margin: 0;
        background: #0f172a;
        color: #e5e7eb;
        font-family: Inter, system-ui, -apple-system, sans-serif;
      }

      .wrap {
        padding: 24px;
      }

      canvas {
        max-height: 420px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <canvas id="chart"></canvas>
    </div>

    <script>
      /**
       * НАСТРОЙКИ
       */
      const SPREADSHEET_ID = "1eXIDfssSkmzH2ofB0jkM5i0GDC7fOPlnEOMvfhs5Vn8";
      const SHEET_GID = "1459377171"; // <-- gid листа result
      const REFRESH_INTERVAL = 1500; // мс

      const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

      let chart;
      let lastTotal = 0;

      /**
       * Загрузка и парсинг CSV
       */
      async function loadData() {
        const res = await fetch(CSV_URL + "&_=" + Date.now(), {
          cache: "no-store",
        });
        const text = await res.text();

        const rows = text.trim().split("\n");
        if (rows.length < 2) return;

        const labels = rows[0].split(",").map((v) => v.trim());
        const values = rows[1].split(",").map((v) => Number(v));

        updateChart(labels, values);
      }

      /**
       * Инициализация графика
       */
      function initChart(labels, values) {
        const ctx = document.getElementById("chart");

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                data: values,
                backgroundColor: "#38bdf8",
                borderRadius: 10,
              },
            ],
          },
          options: {
            responsive: true,
            animation: {
              duration: 700,
              easing: "easeOutQuart",
            },
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: {
                  color: "#cbd5f5",
                  font: { size: 14 },
                },
                grid: { display: false },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  color: "#cbd5f5",
                  stepSize: 1,
                },
                grid: {
                  color: "rgba(255,255,255,0.08)",
                },
              },
            },
          },
        });
      }

      /**
       * Обновление данных графика
       */
      function updateChart(labels, values) {
        if (!chart) {
          initChart(labels, values);
          return;
        }

        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update();
      }

      /**
       * Старт
       */
      loadData();
      setInterval(loadData, REFRESH_INTERVAL);
    </script>
  </body>
</html>
